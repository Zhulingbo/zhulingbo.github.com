<!DOCTYPE html>
<!--[if IEMobile 7 ]>
<html class="no-js iem7"> <![endif]-->
<!--[if (gt IEMobile 7)|!(IEMobile)]><!-->
<html class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <title>KFC</title>
    <meta name="description" content="">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="cleartype" content="on">
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <link rel="stylesheet" href="css/common.css">
    <script type="text/javascript" src="js/jquery.min2.0.3.js" ></script>
    <link rel="stylesheet" href="css/style.css" />
    <style type="text/css">
        .can_box{width: 79%;height: 79%;overflow: hidden;background-color: #ccc;margin: 1rem auto auto auto;}
    </style>
</head>
<body>
<!-- container -->
<div class="container home">
    <div class="can_box">
       <canvas id="mycanvas"></canvas> 
    </div>
</div>
<!-- container -->
<script src="js/app.js" id="appjs" data-adapt="1" ></script>
<script type="text/javascript" src="js/jcanvas.js"></script>
<script type="text/javascript" src="js/binaryajax.js"></script>
<script src="js/hammer.min.js"></script>
<script type="text/javascript">
$(function() {
    $("body").on('touchmove', function (event) {
            event.preventDefault();
        });
    //canvas 触控(放大缩小)
    // --------------------------------------------------
    // --------------------------------------------------
            var timer = null;
        function controlImage(img,rot){
            var
                    doc = document,
                    radio = img.height / img.width,
                    transformParams = {
                        scale:1,
                        initWidth:canvas.width,
                        initHeight:canvas.width * radio,
                        initLeft:0,
                        initTop:0,
                        differX:0,
                        differY:0
                    },
                    boundry = {
                        maxScale:3,
                        minScale:0.5
                    },
                    mc = new Hammer.Manager(doc.querySelector('.can_box'))
                    ;
            mc.add(new Hammer.Pan({ threshold: 0, pointers: 0 }));
            mc.add(new Hammer.Pinch({ threshold: 0 })).recognizeWith(mc.get('pan'));

            mc.on("panstart panmove panend", onPan);
            mc.on("pinchmove pinchstart", onPinch);

            loop();
            function loop(){
                timer = setTimeout(loop,100);
                reqAnimationFrame();
            }
            function reqAnimationFrame(){
                var w = transformParams.initWidth;
                var h = transformParams.initHeight;

                ctx.setTransform(1,0,0,1,0,0);
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.translate(transformParams.initLeft+transformParams.differX+w/2,transformParams.initTop+transformParams.differY+h/2);
                ctx.scale(transformParams.scale,transformParams.scale);
                ctx.rotate(rot * Math.PI/180);
                ctx.drawImage(img, -w/2, -h/2,w,h );
            }

            function onPan(e){
                transformParams.differX = e.deltaX;
                transformParams.differY = e.deltaY;

                reqAnimationFrame();
                if(e.type == 'panend'){
                    transformParams.initLeft += transformParams.differX;
                    transformParams.initTop += transformParams.differY;
                    transformParams.differX = 0;
                    transformParams.differY = 0;
                }
            }

//        var show = doc.querySelector('.show');
            var initScale = 0;
            function onPinch(e){
                if(e.type == 'pinchstart') {
                    initScale = transformParams.scale || 1;
                }
                transformParams.scale = initScale * e.scale;
                if(transformParams.scale >= boundry.maxScale) transformParams.scale = boundry.maxScale;
                if(transformParams.scale <= boundry.minScale) transformParams.scale = boundry.minScale;
//            show.innerHTML += e.scale+'\n';
                reqAnimationFrame();
            }



        function controlStart(){
            var orientation = exif ? exif.Orientation : 1;
            switch(orientation) {
                case 3:
                    imgRotation = 180;
                    break;
                case 6:
                    imgRotation = 90;
                    break;
                case 8:
                    imgRotation = 270;
                    break;
                default:
                    imgRotation = 0;
                    break;
            }

            var rot = imgRotation || 0;
//            alert(rot);
            if(timer) clearTimeout(timer);
            ctx.drawImage(img2, 0, 0,canvas.width,canvas.height);
            controlImage(img);
        }
        }
    //canvas 触控
    //----------------------------------------------------
    //----------------------------------------------------

    var canvas = document.getElementById('mycanvas');
    var ctx = canvas.getContext("2d");
    var img = new Image();
    var canW = $(".can_box").width();
    var canH = $(".can_box").height();
    canvas.height = canH;
    canvas.width = canW;
    img.src = "img/result_img.png";
    img.onload = function(){
        ctx.drawImage(img, 0, 0,canvas.width,canvas.height);
        controlImage(img);
    }
});
</script>
</body>
</html>